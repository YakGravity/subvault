<div style="padding:16px;">
    <form {{if .IsEdit}}hx-put="/api/subscriptions/{{.Subscription.ID}}"{{else}}hx-post="/api/subscriptions"{{end}}
          hx-target="#form-errors"
          hx-swap="innerHTML"
          hx-on::after-request="if(event.detail.successful) { if(event.detail.xhr.status === 201 || event.detail.xhr.status === 200) { window.location.reload(); } }">

        <!-- Header: Title left, Buttons right -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <h3 style="font-size:18px;font-weight:600;color:var(--text);">
                {{if .IsEdit}}{{.T.Tr "sub_form_edit_title"}}{{else}}{{.T.Tr "sub_form_add_title"}}{{end}}
            </h3>
            <div style="display:flex;gap:12px;">
                <button type="button" onclick="document.getElementById('modal').classList.remove('active')"
                        class="btn btn-ghost">
                    {{.T.Tr "btn_cancel"}}
                </button>
                <button type="submit"
                        class="btn btn-primary">
                    {{.T.Tr "btn_save"}}
                </button>
            </div>
        </div>

        <div id="form-errors" style="margin-bottom:12px;"></div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <!-- Row 1: Name (full width) -->
            <div style="grid-column:span 3;">
                <label for="name" class="form-label">{{.T.Tr "sub_form_name"}} *</label>
                <input type="text" id="name" name="name" required
                       value="{{if .Subscription}}{{.Subscription.Name}}{{end}}"
                       class="form-input">
            </div>

            <!-- Row 2: Kategorie | Kosten | Währung -->
            <div>
                <label for="category_id" class="form-label">{{.T.Tr "sub_form_category"}} *</label>
                <div style="display:flex;gap:8px;">
                    <div style="flex:1;" id="category-select-container">
                        <select id="category_id" name="category_id" required
                                class="form-input form-select">
                            <option value="">{{.T.Tr "sub_form_select_category"}}</option>
                            {{range .Categories}}
                                <option value="{{.ID}}" {{if $.Subscription}}{{if $.Subscription.ID}}{{if eq $.Subscription.CategoryID .ID}}selected{{end}}{{else}}{{if eq .ID $.DefaultCategoryID}}selected{{end}}{{end}}{{end}}>{{.Name}}</option>
                            {{end}}
                        </select>
                    </div>
                    <button type="button" id="add-category-btn" onclick="showNewCategoryInput()"
                            class="btn btn-ghost" style="padding:6px 8px;color:var(--accent);"
                            title="Add new category">
                        <svg style="width:16px;height:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
                <!-- Inline new category input (hidden by default) -->
                <div id="new-category-container" class="hidden" style="margin-top:8px;">
                    <input type="text" id="new-category-name" placeholder="{{.T.Tr "placeholder_new_category"}}"
                           class="form-input" style="width:100%;margin-bottom:8px;">
                    <div style="display:flex;gap:8px;">
                        <button type="button" onclick="createNewCategory()"
                                class="btn btn-primary">
                            {{.T.Tr "btn_add"}}
                        </button>
                        <button type="button" onclick="hideNewCategoryInput()"
                                class="btn btn-ghost">
                            {{.T.Tr "btn_cancel"}}
                        </button>
                    </div>
                    <div id="new-category-error" class="hidden" style="font-size:13px;color:var(--danger);margin-top:4px;"></div>
                </div>
            </div>

            <div>
                <label for="cost" class="form-label">{{.T.Tr "sub_form_cost"}} *</label>
                <div style="position:relative;">
                    <span id="cost-currency-symbol" style="position:absolute;left:12px;top:8px;color:var(--text-muted);">{{.CurrencySymbol}}</span>
                    <input type="number" id="cost" name="cost" step="0.01" min="0" required
                           value="{{if .Subscription}}{{.Subscription.Cost}}{{end}}"
                           class="form-input" style="padding-left:32px;">
                </div>
            </div>

            <div>
                <label for="original_currency" class="form-label">{{.T.Tr "sub_form_currency"}} *</label>
                <select id="original_currency" name="original_currency" required
                        class="form-input form-select">
                    <option value="USD" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "USD"}}selected{{end}}{{else}}selected{{end}}>$ USD</option>
                    <option value="EUR" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "EUR"}}selected{{end}}{{end}}>&#8364; EUR</option>
                    <option value="GBP" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "GBP"}}selected{{end}}{{end}}>&#163; GBP</option>
                    <option value="JPY" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "JPY"}}selected{{end}}{{end}}>&#165; JPY</option>
                    <option value="RUB" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "RUB"}}selected{{end}}{{end}}>&#8381; RUB</option>
                    <option value="SEK" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "SEK"}}selected{{end}}{{end}}>kr SEK</option>
                    <option value="PLN" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "PLN"}}selected{{end}}{{end}}>z&#322; PLN</option>
                    <option value="INR" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "INR"}}selected{{end}}{{end}}>&#8377; INR</option>
                    <option value="CHF" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "CHF"}}selected{{end}}{{end}}>Fr. CHF</option>
                    <option value="BRL" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "BRL"}}selected{{end}}{{end}}>R$ BRL</option>
                    <option value="COP" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "COP"}}selected{{end}}{{end}}>$ COP</option>
                    <option value="BDT" {{if .Subscription}}{{if eq .Subscription.OriginalCurrency "BDT"}}selected{{end}}{{end}}>&#2547; BDT</option>
                </select>
            </div>

            <!-- Row 3: Zyklus | Status | Startdatum -->
            <div>
                <label for="schedule" class="form-label">{{.T.Tr "sub_form_schedule"}} *</label>
                <select id="schedule" name="schedule" required
                        class="form-input form-select">
                    <option value="">{{.T.Tr "sub_form_schedule"}}</option>
                    <option value="Monthly" {{if .Subscription}}{{if eq .Subscription.Schedule "Monthly"}}selected{{end}}{{end}}>{{.T.Tr "schedule_monthly"}}</option>
                    <option value="Quarterly" {{if .Subscription}}{{if eq .Subscription.Schedule "Quarterly"}}selected{{end}}{{end}}>{{.T.Tr "schedule_quarterly"}}</option>
                    <option value="Annual" {{if .Subscription}}{{if eq .Subscription.Schedule "Annual"}}selected{{end}}{{end}}>{{.T.Tr "schedule_annual"}}</option>
                    <option value="Weekly" {{if .Subscription}}{{if eq .Subscription.Schedule "Weekly"}}selected{{end}}{{end}}>{{.T.Tr "schedule_weekly"}}</option>
                    <option value="Daily" {{if .Subscription}}{{if eq .Subscription.Schedule "Daily"}}selected{{end}}{{end}}>{{.T.Tr "schedule_daily"}}</option>
                </select>
            </div>

            <div>
                <label for="status" class="form-label">{{.T.Tr "sub_form_status"}} *</label>
                <select id="status" name="status" required
                        class="form-input form-select">
                    <option value="">{{.T.Tr "sub_form_status"}}</option>
                    <option value="Active" {{if .Subscription}}{{if eq .Subscription.Status "Active"}}selected{{end}}{{end}}>{{.T.Tr "status_active"}}</option>
                    <option value="Cancelled" {{if .Subscription}}{{if eq .Subscription.Status "Cancelled"}}selected{{end}}{{end}}>{{.T.Tr "status_cancelled"}}</option>
                    <option value="Paused" {{if .Subscription}}{{if eq .Subscription.Status "Paused"}}selected{{end}}{{end}}>{{.T.Tr "status_paused"}}</option>
                    <option value="Trial" {{if .Subscription}}{{if eq .Subscription.Status "Trial"}}selected{{end}}{{end}}>{{.T.Tr "status_trial"}}</option>
                </select>
            </div>

            <div>
                <label for="start_date" class="form-label">{{.T.Tr "sub_form_start_date"}}</label>
                <input type="date" id="start_date" name="start_date"
                       value="{{if .Subscription}}{{if .Subscription.StartDate}}{{.Subscription.StartDate.Format "2006-01-02"}}{{end}}{{end}}"
                       class="form-input">
            </div>

            <!-- Row 4: Preisart | Steuersatz | Zahlungsmethode -->
            <div>
                <label for="price_type" class="form-label">{{.T.Tr "sub_form_price_type"}}</label>
                <select id="price_type" name="price_type" onchange="updateTaxCalculation()"
                        class="form-input form-select">
                    <option value="gross" {{if .Subscription}}{{if eq .Subscription.PriceType "gross"}}selected{{end}}{{end}}>{{.T.Tr "price_type_gross"}}</option>
                    <option value="net" {{if .Subscription}}{{if eq .Subscription.PriceType "net"}}selected{{end}}{{end}}>{{.T.Tr "price_type_net"}}</option>
                </select>
            </div>

            <div>
                <label for="tax_rate" class="form-label">{{.T.Tr "sub_form_tax_rate"}}</label>
                <input type="number" id="tax_rate" name="tax_rate" min="0" max="100" step="0.1"
                       value="{{if .Subscription}}{{.Subscription.TaxRate}}{{end}}" onchange="updateTaxCalculation()" oninput="updateTaxCalculation()"
                       class="form-input"
                       placeholder="0">
            </div>

            <div>
                <label for="payment_method" class="form-label">{{.T.Tr "sub_form_payment_method"}}</label>
                <input type="text" id="payment_method" name="payment_method"
                       value="{{if .Subscription}}{{.Subscription.PaymentMethod}}{{end}}"
                       placeholder="{{.T.Tr "placeholder_payment_method"}}"
                       class="form-input">
            </div>

            <!-- Row 5: Tax Calculation (always visible, full width) -->
            <div style="grid-column:span 3;">
                <div id="tax-calculation" style="background:var(--bg);border-radius:var(--radius-sm);padding:8px;font-size:13px;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
                        <div>
                            <span style="color:var(--text-muted);display:block;font-size:12px;">{{.T.Tr "sub_form_net_cost"}}</span>
                            <span id="tax-net" style="font-weight:500;color:var(--text);">&mdash;</span>
                        </div>
                        <div>
                            <span style="color:var(--text-muted);display:block;font-size:12px;">{{.T.Tr "sub_form_tax_amount"}}</span>
                            <span id="tax-amount" style="font-weight:500;color:var(--text);">&mdash;</span>
                        </div>
                        <div>
                            <span style="color:var(--text-muted);display:block;font-size:12px;">{{.T.Tr "sub_form_gross_cost"}}</span>
                            <span id="tax-gross" style="font-weight:500;color:var(--text);">&mdash;</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 6: Verlängerung | Kündigung | Nutzungsgrad -->
            <div>
                <label for="renewal_date" class="form-label">
                    <span style="display:flex;align-items:center;">
                        {{.T.Tr "sub_form_renewal_date"}}
                        <span style="position:relative;margin-left:4px;" onmouseenter="this.querySelector('.tooltip-bubble').style.display='block'" onmouseleave="this.querySelector('.tooltip-bubble').style.display='none'">
                            <svg style="width:16px;height:16px;color:var(--text-muted);cursor:help;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="tooltip-bubble" style="position:absolute;left:0;bottom:100%;margin-bottom:8px;display:none;z-index:10;width:224px;">
                                <span style="background:var(--bg-nav);color:#fff;font-size:12px;border-radius:var(--radius-sm);padding:8px 12px;display:block;box-shadow:var(--shadow-md);">
                                    {{.T.Tr "tooltip_renewal_date"}}
                                </span>
                            </span>
                        </span>
                    </span>
                </label>
                <input type="date" id="renewal_date" name="renewal_date"
                       value="{{if .Subscription}}{{if .Subscription.RenewalDate}}{{.Subscription.RenewalDate.Format "2006-01-02"}}{{end}}{{end}}"
                       class="form-input">
            </div>

            <div>
                <label for="cancellation_date" class="form-label">{{.T.Tr "sub_form_cancellation_date"}}</label>
                <input type="date" id="cancellation_date" name="cancellation_date"
                       value="{{if .Subscription}}{{if .Subscription.CancellationDate}}{{.Subscription.CancellationDate.Format "2006-01-02"}}{{end}}{{end}}"
                       class="form-input">
            </div>

            <div>
                <label for="usage" class="form-label">{{.T.Tr "sub_form_usage"}}</label>
                <select id="usage" name="usage"
                        class="form-input form-select">
                    <option value="">{{.T.Tr "sub_form_usage"}}</option>
                    <option value="High" {{if .Subscription}}{{if eq .Subscription.Usage "High"}}selected{{end}}{{end}}>{{.T.Tr "usage_heavy"}}</option>
                    <option value="Medium" {{if .Subscription}}{{if eq .Subscription.Usage "Medium"}}selected{{end}}{{end}}>{{.T.Tr "usage_moderate"}}</option>
                    <option value="Low" {{if .Subscription}}{{if eq .Subscription.Usage "Low"}}selected{{end}}{{end}}>{{.T.Tr "usage_light"}}</option>
                    <option value="None" {{if .Subscription}}{{if eq .Subscription.Usage "None"}}selected{{end}}{{end}}>{{.T.Tr "usage_rarely"}}</option>
                </select>
            </div>

            <!-- Row 7: Login-Name | Kundennummer | Vertragsnummer -->
            <div>
                <label for="login_name" class="form-label">{{.T.Tr "sub_form_login_name"}}</label>
                <input type="text" id="login_name" name="login_name"
                       value="{{if .Subscription}}{{.Subscription.LoginName}}{{end}}"
                       placeholder="{{.T.Tr "placeholder_login_name"}}"
                       class="form-input">
            </div>

            <div>
                <label for="customer_number" class="form-label">{{.T.Tr "sub_form_customer_number"}}</label>
                <input type="text" id="customer_number" name="customer_number"
                       value="{{if .Subscription}}{{.Subscription.CustomerNumber}}{{end}}"
                       placeholder="{{.T.Tr "placeholder_customer_number"}}"
                       class="form-input">
            </div>

            <div>
                <label for="contract_number" class="form-label">{{.T.Tr "sub_form_contract_number"}}</label>
                <input type="text" id="contract_number" name="contract_number"
                       value="{{if .Subscription}}{{.Subscription.ContractNumber}}{{end}}"
                       placeholder="{{.T.Tr "placeholder_contract_number"}}"
                       class="form-input">
            </div>

            <!-- Row 8: Website-URL | Notizen -->
            <div>
                <label for="url" class="form-label">{{.T.Tr "sub_form_website"}}</label>
                <input type="url" id="url" name="url"
                       value="{{if .Subscription}}{{.Subscription.URL}}{{end}}"
                       placeholder="https://example.com"
                       class="form-input">
            </div>

            <div style="grid-column:span 2;">
                <label for="notes" class="form-label">{{.T.Tr "sub_form_notes"}}</label>
                <textarea id="notes" name="notes" rows="2"
                          placeholder="{{.T.Tr "placeholder_notes"}}"
                          class="form-input">{{if .Subscription}}{{.Subscription.Notes}}{{end}}</textarea>
            </div>

            <!-- Notifications Section -->
            <div style="grid-column:span 3;border-top:1px solid var(--border);padding-top:16px;margin-top:8px;">
                <h3 style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:12px;">{{.T.Tr "sub_form_section_notifications"}}</h3>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                    <!-- Renewal Reminder -->
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" name="renewal_reminder" id="renewal_reminder"
                                   {{if .Subscription}}{{if .Subscription.RenewalReminder}}checked{{end}}{{end}}
                                   style="width:16px;height:16px;accent-color:var(--accent);">
                            <span style="font-size:13px;font-weight:500;color:var(--text-secondary);">{{.T.Tr "sub_form_renewal_reminder"}}</span>
                        </label>
                        <p class="form-hint">{{.T.Tr "sub_form_renewal_reminder_desc"}}</p>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="number" name="renewal_reminder_days" id="renewal_reminder_days"
                                   value="{{if .Subscription}}{{.Subscription.RenewalReminderDays}}{{else}}3{{end}}"
                                   min="1" max="30"
                                   class="form-input" style="width:80px;">
                            <span class="form-hint">{{.T.Tr "sub_form_renewal_reminder_days"}}</span>
                        </div>
                    </div>

                    <!-- Cancellation Reminder -->
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" name="cancellation_reminder" id="cancellation_reminder"
                                   {{if .Subscription}}{{if .Subscription.CancellationReminder}}checked{{end}}{{end}}
                                   style="width:16px;height:16px;accent-color:var(--accent);">
                            <span style="font-size:13px;font-weight:500;color:var(--text-secondary);">{{.T.Tr "sub_form_cancellation_reminder"}}</span>
                        </label>
                        <p class="form-hint">{{.T.Tr "sub_form_cancellation_reminder_desc"}}</p>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input type="number" name="cancellation_reminder_days" id="cancellation_reminder_days"
                                   value="{{if .Subscription}}{{.Subscription.CancellationReminderDays}}{{else}}7{{end}}"
                                   min="1" max="30"
                                   class="form-input" style="width:80px;">
                            <span class="form-hint">{{.T.Tr "sub_form_cancellation_reminder_days"}}</span>
                        </div>
                    </div>

                    <!-- High Cost Alert -->
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" name="high_cost_alert" id="high_cost_alert"
                                   {{if .Subscription}}{{if .Subscription.HighCostAlert}}checked{{end}}{{end}}
                                   style="width:16px;height:16px;accent-color:var(--accent);">
                            <span style="font-size:13px;font-weight:500;color:var(--text-secondary);">{{.T.Tr "sub_form_high_cost_alert"}}</span>
                        </label>
                        <p class="form-hint">{{.T.Tr "sub_form_high_cost_alert_desc"}}</p>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Inline category creation functions
function showNewCategoryInput() {
    document.getElementById('new-category-container').classList.remove('hidden');
    document.getElementById('add-category-btn').classList.add('hidden');
    document.getElementById('new-category-name').focus();
}

function hideNewCategoryInput() {
    document.getElementById('new-category-container').classList.add('hidden');
    document.getElementById('add-category-btn').classList.remove('hidden');
    document.getElementById('new-category-name').value = '';
    document.getElementById('new-category-error').classList.add('hidden');
}

let isCreatingCategory = false;

async function createNewCategory() {
    // Prevent double-submission
    if (isCreatingCategory) return;

    const nameInput = document.getElementById('new-category-name');
    const errorDiv = document.getElementById('new-category-error');
    const addBtn = document.querySelector('#new-category-container button');
    const name = nameInput.value.trim();

    if (!name) {
        errorDiv.textContent = '{{.T.Tr "category_enter_name"}}';
        errorDiv.classList.remove('hidden');
        return;
    }

    isCreatingCategory = true;
    if (addBtn) addBtn.disabled = true;

    try {
        const response = await fetch('/api/categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: name }),
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to create category');
        }

        const newCategory = await response.json();

        // Validate response before adding
        if (!newCategory.id || !newCategory.name) {
            throw new Error('Invalid response from server');
        }

        // Add new option to dropdown and select it
        const select = document.getElementById('category_id');
        const option = document.createElement('option');
        option.value = newCategory.id;
        option.textContent = newCategory.name;
        option.selected = true;
        select.appendChild(option);

        // Hide the input and reset
        hideNewCategoryInput();
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    } finally {
        isCreatingCategory = false;
        if (addBtn) addBtn.disabled = false;
    }
}

// Allow Enter key to submit new category
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement.id === 'new-category-name') {
        e.preventDefault();
        createNewCategory();
    }
});

function calculateRenewalDate() {
    const scheduleSelect = document.getElementById('schedule');
    const statusSelect = document.getElementById('status');
    const renewalDateInput = document.getElementById('renewal_date');

    if (!scheduleSelect.value) {
        return;
    }

    // Calculate renewal date regardless of status for live preview
    const today = new Date();
    let renewalDate = new Date(today);

    switch (scheduleSelect.value) {
        case 'Daily':
            renewalDate.setDate(today.getDate() + 1);
            break;
        case 'Weekly':
            renewalDate.setDate(today.getDate() + 7);
            break;
        case 'Monthly': {
            // Robust month addition: handle month-end dates
            const targetMonth = today.getMonth() + 1;
            const targetYear = today.getFullYear() + (targetMonth > 11 ? 1 : 0);
            const normalizedMonth = targetMonth % 12;
            // Get last day of target month
            const lastDayOfTargetMonth = new Date(targetYear, normalizedMonth + 1, 0).getDate();
            const day = Math.min(today.getDate(), lastDayOfTargetMonth);
            renewalDate = new Date(targetYear, normalizedMonth, day);
            break;
        }
        case 'Quarterly': {
            // Robust quarter addition: handle month-end dates (3 months)
            const targetMonth = today.getMonth() + 3;
            const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
            const normalizedMonth = targetMonth % 12;
            // Get last day of target month
            const lastDayOfTargetMonth = new Date(targetYear, normalizedMonth + 1, 0).getDate();
            const day = Math.min(today.getDate(), lastDayOfTargetMonth);
            renewalDate = new Date(targetYear, normalizedMonth, day);
            break;
        }
        case 'Annual':
            renewalDate.setFullYear(today.getFullYear() + 1);
            break;
        default:
            return;
    }

    // Format date as YYYY-MM-DD for input field (using local timezone)
    const year = renewalDate.getFullYear();
    const month = String(renewalDate.getMonth() + 1).padStart(2, '0');
    const day = String(renewalDate.getDate()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;
    renewalDateInput.value = formattedDate;
}

// Add event listeners when modal content loads
function initRenewalCalculator() {
    const scheduleSelect = document.getElementById('schedule');

    if (scheduleSelect) {
        scheduleSelect.addEventListener('change', calculateRenewalDate);
    }
    // Note: Status changes should NOT trigger renewal date recalculation (fixes #68)
}

// Update cost field currency symbol when currency dropdown changes
function initCurrencySymbolSync() {
    const currencySelect = document.getElementById('original_currency');
    const symbolSpan = document.getElementById('cost-currency-symbol');
    if (!currencySelect || !symbolSpan) return;

    const symbols = {
        'USD': '$', 'EUR': '\u20ac', 'GBP': '\u00a3', 'JPY': '\u00a5', 'RUB': '\u20bd',
        'SEK': 'kr', 'PLN': 'z\u0142', 'INR': '\u20b9', 'CHF': 'Fr.', 'BRL': 'R$',
        'COP': '$', 'BDT': '\u09f3'
    };

    function updateSymbol() {
        symbolSpan.textContent = symbols[currencySelect.value] || '$';
    }

    currencySelect.addEventListener('change', updateSymbol);
    updateSymbol();
}
initCurrencySymbolSync();

// Initialize immediately since this script loads with the form
initRenewalCalculator();

// Also initialize on DOM content loaded as backup
document.addEventListener('DOMContentLoaded', initRenewalCalculator);

// --- Tax Calculation (always visible) ---
function updateTaxCalculation() {
    const cost = parseFloat(document.getElementById('cost').value) || 0;
    const taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
    const priceType = document.getElementById('price_type').value;

    if (taxRate > 0 && cost > 0) {
        let netCost, grossCost, taxAmount;

        if (priceType === 'net') {
            netCost = cost;
            grossCost = cost * (1 + taxRate / 100);
            taxAmount = grossCost - netCost;
        } else {
            grossCost = cost;
            netCost = cost / (1 + taxRate / 100);
            taxAmount = grossCost - netCost;
        }

        document.getElementById('tax-net').textContent = netCost.toFixed(2);
        document.getElementById('tax-gross').textContent = grossCost.toFixed(2);
        document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
    } else if (cost > 0) {
        document.getElementById('tax-net').textContent = cost.toFixed(2);
        document.getElementById('tax-gross').textContent = cost.toFixed(2);
        document.getElementById('tax-amount').textContent = '0.00';
    } else {
        document.getElementById('tax-net').textContent = '\u2014';
        document.getElementById('tax-gross').textContent = '\u2014';
        document.getElementById('tax-amount').textContent = '\u2014';
    }
}

// Initialize tax calculation on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTaxCalculation();
    // Also update when cost changes
    const costInput = document.getElementById('cost');
    if (costInput) {
        costInput.addEventListener('input', updateTaxCalculation);
        costInput.addEventListener('change', updateTaxCalculation);
    }
});

// Run immediately since script loads with form
updateTaxCalculation();
</script>
